<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pipeline Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; color: #333; }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;}
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .status-success { color: #27ae60; font-weight: bold; }
        .status-failed, .status-error { color: #e74c3c; font-weight: bold; }
        .status-skipped { color: #95a5a6; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #bdc3c7; padding: 10px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .error-details { background-color: #f2dede; border-left: 5px solid #e74c3c; padding: 10px; margin-top: 10px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body>
    <h1>Pipeline Data Report - {{ report.execution_date }}</h1>
    <div class="summary">
        <strong>Overall Status:</strong> 
        <span class="status-{{ report.overall_status|lower }}">
            {{ report.overall_status }}
        </span><br>
        <strong>Total Execution Time:</strong> {{ "%.2f"|format(report.total_time_seconds) }} seconds
    </div>

    {% if report.error %}
    <h2>üí• Critical Error Details</h2>
    <div class="error-details"><pre><code>{{ report.error }}</code></pre></div>
    {% endif %}

    <h2>üì• Phase 1: Staging Layer (T·∫£i d·ªØ li·ªáu th√¥)</h2>
    <table>
        <tr><th>Branch ID</th><th>Extracted Records</th><th>Status</th></tr>
        {% for branch_id, stats in report.staging|dictsort %}
        <tr>
            <td>{{ branch_id }}</td>
            <td>{{ stats.record_count }}</td>
            <td class="status-{{ stats.status|lower }}">{{ stats.status }}</td>
        </tr>
        {% endfor %}
    </table>

    <h2>üóÇÔ∏è Phase 2.1: Historical Layer (Theo d√µi thay ƒë·ªïi)</h2>
    <table>
        <tr><th>Branch ID</th><th>M·ªõi</th><th>Thay ƒë·ªïi</th><th>Kh√¥ng ƒë·ªïi</th><th>Th·ªùi gian (gi√¢y)</th><th>Status</th></tr>
        {% for branch_id, stats in report.historical|dictsort %}
        <tr>
            <td>{{ branch_id }}</td>
            <td style="color: #27ae60;">{{ stats.new_records }}</td>
            <td style="color: #f39c12;">{{ stats.updated_records }}</td>
            <td>{{ stats.unchanged_records }}</td>
            <td>{{ "%.2f"|format(stats.duration_seconds) }}</td>
            <td class="status-{{ stats.status|lower }}">{{ stats.status }}</td>
        </tr>
        {% endfor %}
    </table>

    <h2>üìä Phase 2.2: Data Warehouse Layer (K·∫øt qu·∫£ cu·ªëi c√πng)</h2>
    <table>
        <tr><th>Processor</th><th>Input Records</th><th>Output Records</th><th>Th·ªùi gian (gi√¢y)</th><th>Status</th></tr>
        {% for name, stats in report.dwh|dictsort %}
        <tr>
            <td>{{ name }}</td>
            <td>{{ stats.input_records }}</td>
            <td>{{ stats.output_records }}</td>
            <td>{{ "%.2f"|format(stats.duration_seconds) }}</td>
            <td class="status-{{ stats.status|lower }}">{{ stats.status }}</td>
        </tr>
        {% endfor %}
    </table>
    
    <h2>‚òÅÔ∏è Phase 3: Google Drive Upload</h2>
    <table>
        <tr><th>Layer</th><th>Files Uploaded</th><th>Files Updated</th><th>Status</th></tr>
        {% for layer, stats in report.gdrive|dictsort %}
        <tr>
            <td>{{ layer|capitalize }}</td>
            <td>{{ stats.files_uploaded }}</td>
            <td>{{ stats.files_updated }}</td>
            <td class="status-{{ stats.status|lower }}">{{ stats.status }}</td>
        </tr>
        {% endfor %}
    </table>
</body>
</html>